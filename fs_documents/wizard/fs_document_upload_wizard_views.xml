<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================== -->
    <!-- Generic Document Upload Wizard Form View   -->
    <!-- Flow: Entity Type → Entity → Document Type -->
    <!-- ========================================== -->
    <record id="view_fs_document_upload_wizard_form" model="ir.ui.view">
        <field name="name">fs.document.upload.wizard.form</field>
        <field name="model">fs.document.upload.wizard</field>
        <field name="arch" type="xml">
            <form string="Upload Document">
                <sheet>
                    <!-- Technical fields for state persistence -->
                    <div invisible="1">
                        <field name="document_id" force_save="1"/>
                        <field name="entity_type_id" force_save="1"/>
                        <field name="student_id" force_save="1"/>
                        <field name="instructor_id" force_save="1"/>
                        <field name="pilot_id" force_save="1"/>
                        <field name="training_class_id" force_save="1"/>
                        <field name="class_type_id" force_save="1"/>
                        <field name="admin_task_id" force_save="1"/>
                        <field name="document_type_id" force_save="1"/>
                    </div>
                    
                    <!-- Statusbar -->
                    <group>
                        <field name="state" widget="statusbar" statusbar_visible="type,upload,details"/>
                    </group>

                    <!-- Step 1: Select Entity Type → Entity → Document Type -->
                    <group invisible="state != 'type'">
                        <separator string="Step 1: Select Type"/>
                        
                        <!-- 1. Entity Type Selection -->
                        <group string="1. Select Entity Type">
                            <field name="entity_type_id" options="{'no_create': True}"/>
                            <field name="entity_type_code" invisible="1"/>
                        </group>
                        
                        <!-- 2. Entity Selection (visible based on entity_type_code) -->
                        <group string="2. Select Entity" invisible="not entity_type_id">
                            <field name="student_id" options="{'no_create': True}" 
                                   invisible="entity_type_code != 'student'"
                                   required="entity_type_code == 'student' and state == 'type'"/>
                            <field name="instructor_id" options="{'no_create': True}" 
                                   invisible="entity_type_code != 'instructor'"
                                   required="entity_type_code == 'instructor' and state == 'type'"/>
                            <field name="pilot_id" options="{'no_create': True}" 
                                   invisible="entity_type_code != 'pilot'"
                                   required="entity_type_code == 'pilot' and state == 'type'"/>
                            <field name="training_class_id" options="{'no_create': True}" 
                                   invisible="entity_type_code != 'training_class'"
                                   required="entity_type_code == 'training_class' and state == 'type'"/>
                            <field name="class_type_id" options="{'no_create': True}" 
                                   invisible="entity_type_code != 'class_type'"
                                   required="entity_type_code == 'class_type' and state == 'type'"/>
                            <!-- Optional admin task for training class -->
                            <field name="admin_task_domain" invisible="1"/>
                            <field name="admin_task_id" options="{'no_create': True}" 
                                   domain="admin_task_domain"
                                   invisible="entity_type_code != 'training_class' or not training_class_id"
                                   string="Link to Admin Task (Optional)"/>
                        </group>
                        
                        <!-- 3. Document Type Selection (filtered by entity type) -->
                        <group string="3. Select Document Type" invisible="not entity_type_id">
                            <field name="document_type_domain" invisible="1"/>
                            <field name="document_type_id" options="{'no_create': True}" 
                                   domain="document_type_domain"
                                   required="state == 'type'"/>
                            <field name="document_type_code" invisible="1"/>
                        </group>
                        
                        <!-- Show if document exists -->
                        <group invisible="is_new_document or not document_type_id">
                            <field name="existing_document_id" invisible="1"/>
                            <div class="alert alert-info" role="alert">
                                <i class="fa fa-info-circle me-2" title="Info"/>
                                A document of this type already exists. A new version will be added.
                            </div>
                        </group>
                        <field name="is_new_document" invisible="1"/>
                    </group>

                    <!-- Step 2: Upload File -->
                    <group invisible="state != 'upload'">
                        <separator string="Step 2: Upload File"/>
                        <group>
                            <field name="document_type_name" readonly="1" string="Document Type"/>
                        </group>
                        <group>
                            <field name="file" filename="filename" widget="binary"/>
                            <field name="filename"/>
                        </group>
                        <group string="Notes (Optional)" colspan="2" col="1">
                            <field name="notes" nolabel="1" placeholder="Notes about this file..."/>
                        </group>
                    </group>

                    <!-- Step 3: Enter Details -->
                    <group invisible="state != 'details'">
                        <separator string="Step 3: Enter Details"/>
                        <group string="Document Information">
                            <field name="reference" placeholder="e.g., CERT-2024-001"/>
                            <field name="issue_date"/>
                            <field name="has_expiry" invisible="1"/>
                            <field name="expiry_date" invisible="not has_expiry" required="has_expiry and state == 'details'"/>
                        </group>
                        <group string="Summary">
                            <field name="document_type_name" readonly="1" string="Document Type"/>
                            <field name="filename" readonly="1"/>
                            <field name="student_id" readonly="1" invisible="not student_id"/>
                            <field name="instructor_id" readonly="1" invisible="not instructor_id"/>
                            <field name="pilot_id" readonly="1" invisible="not pilot_id"/>
                            <field name="training_class_id" readonly="1" invisible="not training_class_id"/>
                            <field name="admin_task_id" readonly="1" invisible="not admin_task_id"/>
                            <field name="class_type_id" readonly="1" invisible="not class_type_id"/>
                        </group>
                        <group invisible="is_new_document">
                            <div class="alert alert-info" role="alert">
                                <i class="fa fa-info-circle me-2" title="Info"/>
                                This will add a new version to the existing document.
                            </div>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <button name="action_previous" 
                            string="Previous" 
                            type="object" 
                            class="btn-secondary"
                            invisible="state == 'type'"/>
                    <button name="action_next" 
                            string="Next" 
                            type="object" 
                            class="btn-primary"
                            invisible="state == 'details'"/>
                    <button name="action_submit" 
                            string="Upload Document" 
                            type="object" 
                            class="btn-primary"
                            invisible="state != 'details'"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Action to open wizard (generic, no entity pre-selected) -->
    <record id="action_fs_document_upload_wizard" model="ir.actions.act_window">
        <field name="name">Upload Document</field>
        <field name="res_model">fs.document.upload.wizard</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_fs_document_upload_wizard_form"/>
        <field name="target">new</field>
    </record>

    <!-- ========================================================= -->
    <!-- Entity-Specific Wizard View (pre-filled entity type/entity) -->
    <!-- ========================================================= -->
    <record id="view_fs_document_upload_wizard_entity_form" model="ir.ui.view">
        <field name="name">fs.document.upload.wizard.entity.form</field>
        <field name="model">fs.document.upload.wizard</field>
        <field name="arch" type="xml">
            <form string="Upload Document">
                <sheet>
                    <!-- Technical fields for state persistence -->
                    <div invisible="1">
                        <field name="document_id" force_save="1"/>
                        <field name="entity_type_id" force_save="1"/>
                        <field name="student_id" force_save="1"/>
                        <field name="instructor_id" force_save="1"/>
                        <field name="pilot_id" force_save="1"/>
                        <field name="training_class_id" force_save="1"/>
                        <field name="class_type_id" force_save="1"/>
                        <field name="admin_task_id" force_save="1"/>
                        <field name="document_type_id" force_save="1"/>
                    </div>

                    <!-- Statusbar -->
                    <group>
                        <field name="state" widget="statusbar" statusbar_visible="type,upload,details"/>
                    </group>

                    <!-- Step 1: Show pre-filled entity and select Document Type -->
                    <group invisible="state != 'type'">
                        <separator string="Step 1: Select Document Type"/>
                        
                        <!-- Pre-filled entity (readonly) -->
                        <group string="Uploading For">
                            <field name="entity_type_id" readonly="1" force_save="1"/>
                            <field name="entity_type_code" invisible="1"/>
                            <!-- Show only the entity that has a value -->
                            <field name="student_id" readonly="1" force_save="1" invisible="not student_id"/>
                            <field name="instructor_id" readonly="1" force_save="1" invisible="not instructor_id"/>
                            <field name="pilot_id" readonly="1" force_save="1" invisible="not pilot_id"/>
                            <field name="training_class_id" readonly="1" force_save="1" invisible="not training_class_id"/>
                            <field name="class_type_id" readonly="1" force_save="1" invisible="not class_type_id"/>
                        </group>
                        
                        <!-- Document type selection (filtered by entity type) -->
                        <group string="Select Document Type">
                            <field name="document_type_domain" invisible="1"/>
                            <field name="document_type_id" options="{'no_create': True}" 
                                   domain="document_type_domain"
                                   required="state == 'type'"/>
                            <field name="document_type_code" invisible="1"/>
                            <!-- Optional: Link to admin task when uploading from training class -->
                            <field name="admin_task_domain" invisible="1"/>
                            <field name="admin_task_id" options="{'no_create': True}"
                                   domain="admin_task_domain"
                                   invisible="not training_class_id or document_type_code != 'ADMIN'"
                                   string="Link to Admin Task"/>
                        </group>
                        
                        <!-- Hidden fields -->
                        <field name="is_new_document" invisible="1"/>
                        
                        <!-- Show if document exists -->
                        <group invisible="is_new_document or not document_type_id">
                            <field name="existing_document_id" invisible="1"/>
                            <div class="alert alert-info" role="alert">
                                <i class="fa fa-info-circle me-2" title="Info"/>
                                A document of this type already exists. A new version will be added.
                            </div>
                        </group>
                    </group>

                    <!-- Step 2: Upload File -->
                    <group invisible="state != 'upload'">
                        <separator string="Step 2: Upload File"/>
                        <group>
                            <field name="document_type_name" readonly="1" string="Document Type"/>
                        </group>
                        <group>
                            <field name="file" filename="filename" widget="binary"/>
                            <field name="filename"/>
                        </group>
                        <group string="Notes (Optional)" colspan="2" col="1">
                            <field name="notes" nolabel="1" placeholder="Notes about this file..."/>
                        </group>
                    </group>

                    <!-- Step 3: Enter Details -->
                    <group invisible="state != 'details'">
                        <separator string="Step 3: Enter Details"/>
                        <group string="Document Information">
                            <field name="reference" placeholder="e.g., CERT-2024-001"/>
                            <field name="issue_date"/>
                            <field name="has_expiry" invisible="1"/>
                            <field name="expiry_date" invisible="not has_expiry" required="has_expiry and state == 'details'"/>
                        </group>
                        <group string="Summary">
                            <field name="document_type_name" readonly="1" string="Document Type"/>
                            <field name="filename" readonly="1"/>
                            <field name="student_id" readonly="1" invisible="not student_id"/>
                            <field name="instructor_id" readonly="1" invisible="not instructor_id"/>
                            <field name="pilot_id" readonly="1" invisible="not pilot_id"/>
                            <field name="training_class_id" readonly="1" invisible="not training_class_id"/>
                            <field name="admin_task_id" readonly="1" invisible="not admin_task_id"/>
                            <field name="class_type_id" readonly="1" invisible="not class_type_id"/>
                        </group>
                        <group invisible="is_new_document">
                            <div class="alert alert-info" role="alert">
                                <i class="fa fa-info-circle me-2" title="Info"/>
                                This will add a new version to the existing document.
                            </div>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <button name="action_previous" 
                            string="Previous" 
                            type="object" 
                            class="btn-secondary"
                            invisible="state == 'type'"/>
                    <button name="action_next" 
                            string="Next" 
                            type="object" 
                            class="btn-primary"
                            invisible="state == 'details'"/>
                    <button name="action_submit" 
                            string="Upload Document" 
                            type="object" 
                            class="btn-primary"
                            invisible="state != 'details'"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Entity-specific wizard actions -->
    <record id="action_fs_document_upload_wizard_student" model="ir.actions.act_window">
        <field name="name">Upload Document</field>
        <field name="res_model">fs.document.upload.wizard</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_fs_document_upload_wizard_entity_form"/>
        <field name="target">new</field>
    </record>

    <record id="action_fs_document_upload_wizard_instructor" model="ir.actions.act_window">
        <field name="name">Upload Document</field>
        <field name="res_model">fs.document.upload.wizard</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_fs_document_upload_wizard_entity_form"/>
        <field name="target">new</field>
    </record>

    <record id="action_fs_document_upload_wizard_pilot" model="ir.actions.act_window">
        <field name="name">Upload Document</field>
        <field name="res_model">fs.document.upload.wizard</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_fs_document_upload_wizard_entity_form"/>
        <field name="target">new</field>
    </record>

    <record id="action_fs_document_upload_wizard_training_class" model="ir.actions.act_window">
        <field name="name">Upload Document</field>
        <field name="res_model">fs.document.upload.wizard</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_fs_document_upload_wizard_entity_form"/>
        <field name="target">new</field>
    </record>

    <record id="action_fs_document_upload_wizard_class_type" model="ir.actions.act_window">
        <field name="name">Upload Document</field>
        <field name="res_model">fs.document.upload.wizard</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_fs_document_upload_wizard_entity_form"/>
        <field name="target">new</field>
    </record>
</odoo>
